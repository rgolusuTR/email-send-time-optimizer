{% extends "base.html" %} {% block title %}Dashboard - Page Analytics
Notification System{% endblock %} {% block header %}Dashboard{% endblock %} {%
block content %}
<div class="row">
  <!-- Statistics Cards -->
  <div class="col-md-3 mb-4">
    <div class="card text-white bg-primary">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">{{ stats.get('total_alerts', 0) }}</h4>
            <p class="card-text">Total Alerts (30 days)</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-bell fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 mb-4">
    <div class="card text-white bg-danger">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">
              {{ stats.get('alerts_by_type', {}).get('expired', 0) }}
            </h4>
            <p class="card-text">Expired Page Alerts</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-exclamation-triangle fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 mb-4">
    <div class="card text-white bg-warning">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">
              {{ stats.get('alerts_by_type', {}).get('low_engagement', 0) }}
            </h4>
            <p class="card-text">Low Engagement Alerts</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-chart-line fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-3 mb-4">
    <div class="card text-white bg-success">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">
              {{ stats.get('status_counts', {}).get('sent', 0) }}
            </h4>
            <p class="card-text">Emails Sent</p>
          </div>
          <div class="align-self-center">
            <i class="fas fa-envelope fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <!-- Scheduler Status -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div
        class="card-header d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">
          <i class="fas fa-clock"></i>
          Scheduler Status
        </h5>
        <div>
          {% if scheduler_status.get('running') %}
          <span class="badge bg-success">Running</span>
          {% else %}
          <span class="badge bg-secondary">Stopped</span>
          {% endif %}
        </div>
      </div>
      <div class="card-body">
        {% if scheduler_status.get('enabled') %}
        <p>
          <strong>Schedule:</strong> {{ scheduler_status.get('cron_schedule',
          'Not configured') }}
        </p>
        <p>
          <strong>Timezone:</strong> {{ scheduler_status.get('timezone', 'UTC')
          }}
        </p>

        {% if scheduler_status.get('jobs') %}
        <h6>Scheduled Jobs:</h6>
        <ul class="list-unstyled">
          {% for job in scheduler_status.get('jobs', []) %}
          <li>
            <strong>{{ job.name }}</strong><br />
            <small class="text-muted">
              Next run: {{ job.next_run or 'Not scheduled' }}
            </small>
          </li>
          {% endfor %}
        </ul>
        {% endif %}

        <div class="mt-3">
          {% if scheduler_status.get('running') %}
          <button class="btn btn-warning btn-sm" onclick="stopScheduler()">
            <i class="fas fa-stop"></i> Stop Scheduler
          </button>
          {% else %}
          <button class="btn btn-success btn-sm" onclick="startScheduler()">
            <i class="fas fa-play"></i> Start Scheduler
          </button>
          {% endif %}
          <button class="btn btn-primary btn-sm" onclick="triggerManualRun()">
            <i class="fas fa-play-circle"></i> Manual Run
          </button>
        </div>
        {% else %}
        <p class="text-muted">Scheduler is disabled in configuration.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="col-md-6 mb-4">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-bolt"></i>
          Quick Actions
        </h5>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
            <i class="fas fa-upload"></i>
            Upload New Report
          </a>
          <a href="{{ url_for('configuration') }}" class="btn btn-secondary">
            <i class="fas fa-cog"></i>
            Manage Configuration
          </a>
          <button class="btn btn-info" onclick="testEmailConfig()">
            <i class="fas fa-envelope-open"></i>
            Test Email Configuration
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Recent Alerts -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="mb-0">
          <i class="fas fa-history"></i>
          Recent Alerts
        </h5>
      </div>
      <div class="card-body">
        {% if recent_alerts %}
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Page URL</th>
                <th>Alert Type</th>
                <th>Recipient</th>
                <th>Page Views</th>
                <th>Status</th>
                <th>Date Sent</th>
              </tr>
            </thead>
            <tbody>
              {% for alert in recent_alerts %}
              <tr>
                <td>
                  <a
                    href="{{ alert.page_url }}"
                    target="_blank"
                    class="text-decoration-none"
                  >
                    {{ alert.page_url[:50] }}{% if alert.page_url|length > 50
                    %}...{% endif %}
                  </a>
                </td>
                <td>
                  {% if alert.alert_type == 'expired' %}
                  <span class="badge bg-danger">Expired</span>
                  {% elif alert.alert_type == 'low_engagement' %}
                  <span class="badge bg-warning">Low Engagement</span>
                  {% else %}
                  <span class="badge bg-secondary">{{ alert.alert_type }}</span>
                  {% endif %}
                </td>
                <td>{{ alert.recipient_email }}</td>
                <td>{{ alert.page_views }}</td>
                <td>
                  {% if alert.email_status == 'sent' %}
                  <span class="badge bg-success">Sent</span>
                  {% elif alert.email_status == 'failed' %}
                  <span class="badge bg-danger">Failed</span>
                  {% else %}
                  <span class="badge bg-secondary"
                    >{{ alert.email_status }}</span
                  >
                  {% endif %}
                </td>
                <td>
                  <small>{{ alert.alert_sent_date[:19] }}</small>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted text-center">No recent alerts found.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Test Email Modal -->
<div class="modal fade" id="testEmailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Test Email Configuration</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="testEmailForm">
          <div class="mb-3">
            <label for="testEmail" class="form-label">Email Address</label>
            <input type="email" class="form-control" id="testEmail" required />
            <div class="form-text">
              Enter an email address to test the email configuration.
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="sendTestEmail()">
          Send Test Email
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  function startScheduler() {
    $.post("/scheduler/start")
      .done(function (response) {
        if (response.success) {
          location.reload();
        } else {
          alert("Error: " + response.error);
        }
      })
      .fail(function () {
        alert("Error starting scheduler");
      });
  }

  function stopScheduler() {
    $.post("/scheduler/stop")
      .done(function (response) {
        if (response.success) {
          location.reload();
        } else {
          alert("Error: " + response.error);
        }
      })
      .fail(function () {
        alert("Error stopping scheduler");
      });
  }

  function triggerManualRun() {
    if (confirm("This will trigger a manual processing run. Continue?")) {
      $.post("/scheduler/trigger")
        .done(function (response) {
          if (response.success) {
            alert("Manual processing triggered successfully");
          } else {
            alert("Error: " + response.error);
          }
        })
        .fail(function () {
          alert("Error triggering manual run");
        });
    }
  }

  function testEmailConfig() {
    $("#testEmailModal").modal("show");
  }

  function sendTestEmail() {
    const email = $("#testEmail").val();
    if (!email) {
      alert("Please enter an email address");
      return;
    }

    $.post("/test_email", { email: email })
      .done(function (response) {
        if (response.success) {
          alert("Test email sent successfully!");
          $("#testEmailModal").modal("hide");
        } else {
          alert("Error: " + response.error);
        }
      })
      .fail(function () {
        alert("Error sending test email");
      });
  }
</script>
{% endblock %}
